{
    "sourceFile": "main.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1768862925134,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1768862937298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -272,9 +272,9 @@\n \n def main():\n     logger = Logger(\"SQLCompiler\")\n     files = [f for f in os.listdir('.') if f.endswith('.sql') or f.endswith('.txt')]\n-    files = [f for f in files if f in ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql','']]\n+    files = [f for f in files if f in ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql','f']]\n     if not files:\n         print(\"No SQL files found.\")\n         return\n     while True:\n"
                },
                {
                    "date": 1768862943124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -272,9 +272,9 @@\n \n def main():\n     logger = Logger(\"SQLCompiler\")\n     files = [f for f in os.listdir('.') if f.endswith('.sql') or f.endswith('.txt')]\n-    files = [f for f in files if f in ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql','final_test.sql']]\n+    files = [f for f in files if f in ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql','full_test.sql']]\n     if not files:\n         print(\"No SQL files found.\")\n         return\n     while True:\n"
                }
            ],
            "date": 1768862925134,
            "name": "Commit-0",
            "content": "import json\nimport os\nimport tempfile\nimport webbrowser\nfrom antlr4 import *\nfrom antlr4.tree.Tree import TerminalNode\nfrom dataclasses import asdict, is_dataclass\n\n# ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©\nfrom lexers.base_lexer import BaseLexer\nfrom BaseLexer import BaseLexer as MyBaseLexer\nfrom SQLParser import SQLParser as MyParser\nfrom builders.ast_builder import AstBuilder\nfrom lexers.token_classifier import TokenClassifier\nfrom semantic.semantic_analyzer import SemanticAnalyzer\nfrom utils.error_handler import ErrorHandler\nfrom utils.logger import Logger\n\n# --- 1. ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© (Helper Functions) ---\n\ndef to_clean_dict(obj):\n    if is_dataclass(obj):\n        result = {\"type\": obj.__class__.__name__}\n        for k, v in asdict(obj).items():\n            cleaned = to_clean_dict(v)\n            if cleaned is not None and cleaned != \"\" and cleaned != []:\n                result[k] = cleaned\n        return result\n    elif isinstance(obj, list):\n        lst = [to_clean_dict(i) for i in obj]\n        return [i for i in lst if i not in (None, \"\", [])]\n    else:\n        return obj\n\ndef get_tree_structure(node, rule_names, indent=0):\n    if node is None: return []\n    lines = []\n    prefix = \"  \" * indent\n    if isinstance(node, TerminalNode):\n        lines.append(f\"{prefix}TOKEN: {node.getText()}\")\n    else:\n        rule_index = node.getRuleIndex()\n        rule_name = rule_names[rule_index] if rule_index < len(rule_names) else str(rule_index)\n        lines.append(f\"{prefix}RULE: {rule_name}\")\n        for i in range(node.getChildCount()):\n            lines.extend(get_tree_structure(node.getChild(i), rule_names, indent + 1))\n    return lines\n\ndef get_tree_data_for_visualization(node, rule_names, node_id=0, parent_id=None):\n    if node is None: return [], [], node_id\n    nodes, edges = [], []\n    current_id = node_id\n    node_id += 1\n    if isinstance(node, TerminalNode):\n        nodes.append({\n            \"id\": current_id, \"label\": node.getText(), \"type\": \"token\", \"shape\": \"box\",\n            \"color\": \"#ce9178\", \"font\": {\"size\": 22, \"color\": \"white\"}\n        })\n    else:\n        rule_index = node.getRuleIndex()\n        rule_name = rule_names[rule_index] if rule_index < len(rule_names) else str(rule_index)\n        nodes.append({\n            \"id\": current_id, \"label\": rule_name, \"type\": \"rule\", \"shape\": \"ellipse\",\n            \"color\": \"#4ec9b0\", \"font\": {\"size\": 24, \"color\": \"white\", \"bold\": True}\n        })\n        for i in range(node.getChildCount()):\n            child_nodes, child_edges, node_id = get_tree_data_for_visualization(node.getChild(i), rule_names, node_id, current_id)\n            nodes.extend(child_nodes)\n            edges.extend(child_edges)\n    if parent_id is not None: edges.append({\"from\": parent_id, \"to\": current_id})\n    return nodes, edges, node_id\n\ndef convert_ast_to_tree(ast_obj, node_id=0, parent_id=None, key_name=None):\n    nodes, edges = [], []\n    current_id = node_id\n    node_id += 1\n\n    if isinstance(ast_obj, dict):\n        node_type = ast_obj.get('type', key_name if key_name else 'Node')\n        label = node_type.replace('Node', '')\n        nodes.append({\n            \"id\": current_id, \"label\": label, \"type\": \"ast_node\", \"shape\": \"box\",\n            \"color\": \"#c586c0\", \"font\": {\"size\": 26, \"bold\": True, \"color\": \"white\"},\n            \"margin\": 15\n        })\n        if parent_id is not None: edges.append({\"from\": parent_id, \"to\": current_id})\n        for key, value in ast_obj.items():\n            if key == 'type' or value is None or value == \"\" or value == []: continue\n            if isinstance(value, (dict, list)):\n                child_nodes, child_edges, node_id = convert_ast_to_tree(value, node_id, current_id, key)\n                nodes.extend(child_nodes)\n                edges.extend(child_edges)\n            else:\n                nodes.append({\n                    \"id\": node_id, \"label\": f\"{key}: {str(value)}\", \"type\": \"ast_value\", \"shape\": \"box\",\n                    \"color\": \"#dcdcaa\", \"font\": {\"size\": 22, \"color\": \"#1e1e1e\"}\n                })\n                edges.append({\"from\": current_id, \"to\": node_id})\n                node_id += 1\n    elif isinstance(ast_obj, list):\n        list_label = key_name if key_name else \"List\"\n        nodes.append({\n            \"id\": current_id, \"label\": list_label, \"type\": \"ast_list\", \"shape\": \"diamond\",\n            \"color\": \"#569cd6\", \"font\": {\"size\": 20, \"color\": \"white\"}\n        })\n        if parent_id is not None: edges.append({\"from\": parent_id, \"to\": current_id})\n        for item in ast_obj:\n            if item is None or item == \"\" or item == []: continue\n            child_nodes, child_edges, node_id = convert_ast_to_tree(item, node_id, current_id, list_label.rstrip('s'))\n            nodes.extend(child_nodes)\n            edges.extend(child_edges)\n    else:\n        nodes.append({\n            \"id\": current_id, \"label\": str(ast_obj), \"type\": \"ast_value\", \"shape\": \"box\",\n            \"color\": \"#dcdcaa\", \"font\": {\"size\": 22, \"color\": \"#1e1e1e\"}\n        })\n        if parent_id is not None: edges.append({\"from\": parent_id, \"to\": current_id})\n    return nodes, edges, node_id\n\n# --- 2. ÿØÿßŸÑÿ© ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© (Core Processing Function) ---\n\ndef process_file(file_path, logger):\n    try:\n        with open(file_path, \"r\", encoding='utf-8') as f:\n            sql = f.read()\n    except Exception as e:\n        return None, f\"Error reading file: {e}\"\n\n    # ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÑÿ∫ŸàŸä\n    base_lexer = BaseLexer(sql)\n    tokens = base_lexer.get_token_list()\n    classifier = TokenClassifier()\n    classifier.validate_syntax(tokens, sql)\n\n    # ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ≠ŸàŸä\n    lexer = MyBaseLexer(InputStream(sql))\n    token_stream = CommonTokenStream(lexer)\n    token_stream.fill()\n    parser = MyParser(token_stream)\n    tree = parser.sqlScript()\n\n    # ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂\n    parse_tree_lines = get_tree_structure(tree, MyParser.ruleNames)\n    nodes, edges, _ = get_tree_data_for_visualization(tree, MyParser.ruleNames)\n\n    # ÿ®ŸÜÿßÿ° AST\n    builder = AstBuilder()\n    ast = builder.visit(tree)\n    ast_json = json.dumps(to_clean_dict(ast), indent=2, ensure_ascii=False)\n\n    # ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿØŸÑÿßŸÑŸä\n    semantic_analyzer = SemanticAnalyzer()\n    sem_errors, sem_warnings = semantic_analyzer.analyze_tokens(tokens)\n\n    return {\n        \"sql\": sql,\n        \"tokens_count\": len(tokens),\n        \"parse_tree\": \"\\n\".join(parse_tree_lines),\n        \"nodes\": nodes,\n        \"edges\": edges,\n        \"ast_json\": ast_json,\n        \"errors\": parser.getNumberOfSyntaxErrors() if hasattr(parser, 'getNumberOfSyntaxErrors') else 0,\n        \"warnings\": len(classifier.warnings) + len(sem_warnings),\n        \"report\": semantic_analyzer.generate_report()\n    }, None\n\n# --- 3. ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿµŸÅÿ≠ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ±ÿ¶Ÿä (Visualization Function) ---\n\ndef create_tree_visualization(result, filename):\n    parse_nodes_json = json.dumps(result['nodes'], ensure_ascii=False)\n    parse_edges_json = json.dumps(result['edges'], ensure_ascii=False)\n    ast_dict = json.loads(result['ast_json'])\n    ast_nodes, ast_edges, _ = convert_ast_to_tree(ast_dict)\n    ast_nodes_json = json.dumps(ast_nodes, ensure_ascii=False)\n    ast_edges_json = json.dumps(ast_edges, ensure_ascii=False)\n\n    html = f\"\"\"\n    <!DOCTYPE html>\n    <html>\n    <head>\n        <title>SQL Visualizer - {filename}</title>\n        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js\"></script>\n        <style>\n            * {{ margin: 0; padding: 0; box-sizing: border-box; }}\n            body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; overflow: hidden; }}\n            .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }}\n            .header h1 {{ color: white; font-size: 22px; }}\n            .tree-selector {{ display: flex; gap: 10px; }}\n            .tree-btn {{ padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }}\n            .tree-btn.active {{ background: white; color: #667eea; }}\n            .container {{ display: flex; height: calc(100vh - 65px); }}\n            .sidebar {{ width: 280px; background: #252526; padding: 20px; border-right: 1px solid #3e3e42; overflow-y: auto; }}\n            .info-box {{ background: #1e1e1e; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #4ec9b0; }}\n            .info-box label {{ color: #858585; font-size: 11px; display: block; }}\n            .info-box .value {{ color: #d4d4d4; font-size: 16px; font-weight: 600; }}\n            .main-content {{ flex: 1; position: relative; background: #1e1e1e; }}\n            #network {{ width: 100%; height: 100%; }}\n            .legend-item {{ display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; }}\n            .color-box {{ width: 12px; height: 12px; border-radius: 2px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"header\">\n            <h1>üå≥ SQL Compiler Visualizer - {filename}</h1>\n            <div class=\"tree-selector\">\n                <button id=\"parseTreeBtn\" class=\"tree-btn active\" onclick=\"showParseTree()\">Parse Tree</button>\n                <button id=\"astTreeBtn\" class=\"tree-btn\" onclick=\"showASTTree()\">AST Tree</button>\n            </div>\n        </div>\n        <div class=\"container\">\n            <div class=\"sidebar\">\n                <h3>Analysis Info</h3>\n                <div class=\"info-box\"><label>Tokens</label><div class=\"value\">{result['tokens_count']}</div></div>\n                <div class=\"info-box\"><label>Syntax Errors</label><div class=\"value\">{result['errors']}</div></div>\n                <div class=\"info-box\"><label>Warnings</label><div class=\"value\">{result['warnings']}</div></div>\n                <div style=\"margin-top: 20px;\">\n                    <h3>Legend</h3>\n                    <div id=\"parseLegend\">\n                        <div class=\"legend-item\"><div class=\"color-box\" style=\"background: #4ec9b0;\"></div><span>Rule Node</span></div>\n                        <div class=\"legend-item\"><div class=\"color-box\" style=\"background: #ce9178;\"></div><span>Token</span></div>\n                    </div>\n                    <div id=\"astLegend\" style=\"display: none;\">\n                        <div class=\"legend-item\"><div class=\"color-box\" style=\"background: #c586c0;\"></div><span>AST Node</span></div>\n                        <div class=\"legend-item\"><div class=\"color-box\" style=\"background: #569cd6;\"></div><span>List / Group</span></div>\n                        <div class=\"legend-item\"><div class=\"color-box\" style=\"background: #dcdcaa;\"></div><span>Value</span></div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"main-content\"><div id=\"network\"></div></div>\n        </div>\n        <script>\n            const parseNodes = {parse_nodes_json};\n            const parseEdges = {parse_edges_json};\n            const astNodes = {ast_nodes_json};\n            const astEdges = {ast_edges_json};\n            let network = null;\n            function draw(nodes, edges, isAst) {{\n                const container = document.getElementById('network');\n                const data = {{ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) }};\n                const options = {{\n                    layout: {{ hierarchical: {{ direction: 'UD', sortMethod: 'directed', nodeSpacing: isAst ? 400 : 250, levelSeparation: 250 }} }},\n                    physics: {{ enabled: false }},\n                    interaction: {{ hover: true, navigationButtons: true, keyboard: true }}\n                }};\n                network = new vis.Network(container, data, options);\n                network.once('afterDrawing', function() {{\n                    network.moveTo({{ position: {{x: 0, y: 0}}, scale: 0.5, animation: false }});\n                }});\n            }}\n            function showParseTree() {{\n                document.getElementById('parseTreeBtn').classList.add('active');\n                document.getElementById('astTreeBtn').classList.remove('active');\n                document.getElementById('parseLegend').style.display = 'block';\n                document.getElementById('astLegend').style.display = 'none';\n                draw(parseNodes, parseEdges, false);\n            }}\n            function showASTTree() {{\n                document.getElementById('astTreeBtn').classList.add('active');\n                document.getElementById('parseTreeBtn').classList.remove('active');\n                document.getElementById('astLegend').style.display = 'block';\n                document.getElementById('parseLegend').style.display = 'none';\n                draw(astNodes, astEdges, true);\n            }}\n            window.onload = showParseTree;\n        </script>\n    </body>\n    </html>\n    \"\"\"\n    return html\n\n# --- 4. ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (Main Function) ---\n\ndef main():\n    logger = Logger(\"SQLCompiler\")\n    files = [f for f in os.listdir('.') if f.endswith('.sql') or f.endswith('.txt')]\n    files = [f for f in files if f in ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql'Ÿà]]\n    if not files:\n        print(\"No SQL files found.\")\n        return\n    while True:\n        print(\"\\n\" + \"=\" * 60)\n        print(\"üöÄ SQL COMPILER - INTERACTIVE DASHBOARD\")\n        print(\"=\" * 60)\n        for i, f in enumerate(files, 1):\n            print(f\"{i}. {f}\")\n        print(\"0. Exit\")\n        print(\"=\" * 60)\n        choice = input(\"Select a file (0-{}): \".format(len(files)))\n        if choice == '0': break\n        try:\n            idx = int(choice) - 1\n            if 0 <= idx < len(files):\n                selected_file = files[idx]\n                print(f\"\\nüîÑ Analyzing {selected_file}...\")\n                \n                # ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿØÿßŸÑÿ© ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©\n                result, error = process_file(selected_file, logger)\n                \n                if error:\n                    print(f\"‚ùå Error: {error}\")\n                    continue\n                print(f\"‚úÖ Analysis Complete! Tokens: {result['tokens_count']}, Errors: {result['errors']}\")\n                while True:\n                    print(\"\\nOptions:\")\n                    print(\"1. View Trees in Browser (Visual)\")\n                    print(\"2. View Parse Tree (Console)\")\n                    print(\"3. View AST JSON (Console)\")\n                    print(\"4. Back to file list\")\n                    sub = input(\"Choice: \")\n                    if sub == '1':\n                        html = create_tree_visualization(result, selected_file)\n                        with tempfile.NamedTemporaryFile(\"w\", delete=False, suffix=\".html\", encoding='utf-8') as f:\n                            f.write(html)\n                            webbrowser.open(f.name)\n                            print(f\"‚úÖ Visualization opened in browser.\")\n                    elif sub == '2':\n                        print(\"\\n=== PARSE TREE PREVIEW ===\")\n                        lines = result['parse_tree'].split('\\n')\n                        for line in lines[:100]: print(line)\n                        if len(lines) > 100: print(f\"... ({len(lines)-100} more lines)\")\n                    elif sub == '3':\n                        print(\"\\n=== AST JSON ===\")\n                        print(result['ast_json'][:2000])\n                        if len(result['ast_json']) > 2000: print(\"... (truncated)\")\n                    elif sub == '4': break\n            else: print(\"‚ùå Invalid choice.\")\n        except Exception as e: print(f\"‚ùå Error: {e}\")\n\nif __name__ == \"__main__\":\n    main()\n"
        }
    ]
}