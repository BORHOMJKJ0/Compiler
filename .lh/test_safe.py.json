{
    "sourceFile": "test_safe.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768863032373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768863032373,
            "name": "Commit-0",
            "content": "\"\"\"\r\nSafe Parser Test with Timeout\r\nØ§Ø®ØªØ¨Ø§Ø± Ø¢Ù…Ù† Ù…Ø¹ Ø­Ø¯ Ø²Ù…Ù†ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¯\r\n\"\"\"\r\n\r\nimport sys\r\nimport signal\r\nfrom pathlib import Path\r\nfrom antlr4 import *\r\nfrom antlr4.error.ErrorListener import ErrorListener\r\nfrom datetime import datetime\r\n\r\n\r\nclass TimeoutError(Exception):\r\n    \"\"\"Ø®Ø·Ø£ ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª\"\"\"\r\n    pass\r\n\r\n\r\ndef timeout_handler(signum, frame):\r\n    \"\"\"Ù…Ø¹Ø§Ù„Ø¬ ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙˆÙ‚Øª\"\"\"\r\n    raise TimeoutError(\"Parsing timeout!\")\r\n\r\n\r\nclass SQLErrorListener(ErrorListener):\r\n    \"\"\"Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡\"\"\"\r\n\r\n    def __init__(self):\r\n        super().__init__()\r\n        self.errors = []\r\n\r\n    def syntaxError(self, recognizer, offendingSymbol, line, column, msg, e):\r\n        self.errors.append({\r\n            'line': line,\r\n            'column': column,\r\n            'message': msg[:200],  # Ø­Ø¯ Ø£Ù‚ØµÙ‰ 200 Ø­Ø±Ù\r\n            'symbol': offendingSymbol.text[:50] if offendingSymbol else '<EOF>'\r\n        })\r\n\r\n\r\nclass SafeParserTest:\r\n    \"\"\"Ø§Ø®ØªØ¨Ø§Ø± Ø¢Ù…Ù† Ù…Ø¹ timeout\"\"\"\r\n\r\n    def __init__(self, timeout_seconds=5):\r\n        self.timeout = timeout_seconds\r\n\r\n        try:\r\n            from BaseLexer import BaseLexer\r\n            from SQLParser import SQLParser\r\n            self.BaseLexer = BaseLexer\r\n            self.SQLParser = SQLParser\r\n            print(\"âœ… Successfully loaded BaseLexer and SQLParser\\n\")\r\n        except ImportError as e:\r\n            print(f\"âŒ Error importing: {e}\")\r\n            sys.exit(1)\r\n\r\n    def test_file(self, filepath):\r\n        \"\"\"Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù„Ù Ù…Ø¹ timeout\"\"\"\r\n        filepath = Path(filepath)\r\n\r\n        print(\"=\" * 80)\r\n        print(f\"ğŸ§ª TESTING: {filepath.name}\")\r\n        print(\"=\" * 80)\r\n\r\n        if not filepath.exists():\r\n            print(f\"âŒ File not found\")\r\n            return None\r\n\r\n        with open(filepath, 'r', encoding='utf-8') as f:\r\n            sql_code = f.read()\r\n\r\n        # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù\r\n        lines = sql_code.strip().split('\\n')\r\n        print(f\"\\nğŸ“Š File: {len(lines)} lines, {len(sql_code)} chars\")\r\n\r\n        # Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ timeout\r\n        try:\r\n            # ØªÙØ¹ÙŠÙ„ timeout (Windows Ù„Ø§ ÙŠØ¯Ø¹Ù… signal)\r\n            if sys.platform != 'win32':\r\n                signal.signal(signal.SIGALRM, timeout_handler)\r\n                signal.alarm(self.timeout)\r\n\r\n            start_time = datetime.now()\r\n\r\n            # Lexing\r\n            print(f\"\\nâ³ Step 1/3: Lexing...\")\r\n            input_stream = InputStream(sql_code)\r\n            lexer = self.BaseLexer(input_stream)\r\n            token_stream = CommonTokenStream(lexer)\r\n            token_stream.fill()\r\n\r\n            token_count = len(token_stream.tokens)\r\n            print(f\"   âœ… Generated {token_count} tokens\")\r\n\r\n            # Parsing\r\n            print(f\"\\nâ³ Step 2/3: Parsing...\")\r\n            parser = self.SQLParser(token_stream)\r\n\r\n            error_listener = SQLErrorListener()\r\n            parser.removeErrorListeners()\r\n            parser.addErrorListener(error_listener)\r\n\r\n            tree = parser.sqlScript()\r\n\r\n            end_time = datetime.now()\r\n            parsing_time = (end_time - start_time).total_seconds() * 1000\r\n\r\n            # Ø¥Ù„ØºØ§Ø¡ timeout\r\n            if sys.platform != 'win32':\r\n                signal.alarm(0)\r\n\r\n            print(f\"   âœ… Completed in {parsing_time:.2f}ms\")\r\n\r\n            # Ø§Ù„Ù†ØªØ§Ø¦Ø¬\r\n            print(f\"\\nâ³ Step 3/3: Analyzing results...\")\r\n\r\n            if len(error_listener.errors) == 0:\r\n                print(f\"\\n{'=' * 80}\")\r\n                print(f\"âœ… SUCCESS - No syntax errors!\")\r\n                print(f\"   â±ï¸  Time: {parsing_time:.2f}ms\")\r\n                print(f\"   ğŸ¯ Tokens: {token_count}\")\r\n                print(f\"{'=' * 80}\\n\")\r\n                return True\r\n            else:\r\n                print(f\"\\n{'=' * 80}\")\r\n                print(f\"âŒ FAILED - {len(error_listener.errors)} error(s)\")\r\n                print(f\"\\nğŸ“‹ First 3 errors:\")\r\n                for i, err in enumerate(error_listener.errors[:3], 1):\r\n                    print(f\"\\n   Error {i}:\")\r\n                    print(f\"      Line {err['line']}, Col {err['column']}\")\r\n                    print(f\"      {err['message'][:100]}\")\r\n                    if err['symbol']:\r\n                        print(f\"      Near: '{err['symbol'][:30]}'\")\r\n\r\n                if len(error_listener.errors) > 3:\r\n                    print(f\"\\n   ... and {len(error_listener.errors) - 3} more\")\r\n\r\n                print(f\"{'=' * 80}\\n\")\r\n                return False\r\n\r\n        except TimeoutError:\r\n            print(f\"\\n{'=' * 80}\")\r\n            print(f\"â° TIMEOUT - Parsing took too long (>{self.timeout}s)\")\r\n            print(f\"   This indicates an infinite loop or left recursion problem\")\r\n            print(f\"{'=' * 80}\\n\")\r\n            return False\r\n\r\n        except Exception as e:\r\n            print(f\"\\n{'=' * 80}\")\r\n            print(f\"ğŸ’¥ EXCEPTION - {type(e).__name__}\")\r\n            print(f\"   {str(e)[:200]}\")\r\n            print(f\"{'=' * 80}\\n\")\r\n            return False\r\n\r\n        finally:\r\n            # ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ timeout\r\n            if sys.platform != 'win32':\r\n                signal.alarm(0)\r\n\r\n    def test_simple_queries(self):\r\n        \"\"\"Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹\"\"\"\r\n        print(\"\\n\" + \"=\" * 80)\r\n        print(\"ğŸ¯ SIMPLE QUERY TESTS\")\r\n        print(\"=\" * 80)\r\n\r\n        tests = [\r\n            (\"SELECT 1;\", \"Literal\"),\r\n            (\"SELECT * FROM T;\", \"Simple SELECT\"),\r\n            (\"CREATE TABLE T (ID INT);\", \"Simple CREATE\"),\r\n            (\"INSERT INTO T VALUES (1);\", \"Simple INSERT\"),\r\n        ]\r\n\r\n        for sql, desc in tests:\r\n            print(f\"\\nğŸ“ Test: {desc}\")\r\n            print(f\"   SQL: {sql}\")\r\n\r\n            try:\r\n                input_stream = InputStream(sql)\r\n                lexer = self.BaseLexer(input_stream)\r\n                token_stream = CommonTokenStream(lexer)\r\n                parser = self.SQLParser(token_stream)\r\n\r\n                error_listener = SQLErrorListener()\r\n                parser.removeErrorListeners()\r\n                parser.addErrorListener(error_listener)\r\n\r\n                tree = parser.sqlScript()\r\n\r\n                if len(error_listener.errors) == 0:\r\n                    print(f\"   âœ… PASS\")\r\n                else:\r\n                    print(f\"   âŒ FAIL - {len(error_listener.errors)} errors\")\r\n                    print(f\"      {error_listener.errors[0]['message'][:80]}\")\r\n\r\n            except Exception as e:\r\n                print(f\"   ğŸ’¥ EXCEPTION - {str(e)[:80]}\")\r\n\r\n\r\ndef main():\r\n    \"\"\"Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\r\n    print(\"=\" * 80)\r\n    print(\"         SAFE SQL PARSER TEST (WITH TIMEOUT)\")\r\n    print(\"=\" * 80)\r\n    print()\r\n\r\n    tester = SafeParserTest(timeout_seconds=10)\r\n\r\n    # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹\r\n    tester.test_simple_queries()\r\n\r\n    # Ø«Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª\r\n    print(\"\\n\" + \"=\" * 80)\r\n    print(\"ğŸ“ TESTING FILES\")\r\n    print(\"=\" * 80)\r\n\r\n    files = ['sqlInput.txt', 'testing.sql', 'train.sql', 'train2.sql',]\r\n\r\n    for filename in files:\r\n        if Path(filename).exists():\r\n            tester.test_file(filename)\r\n        else:\r\n            print(f\"âš ï¸  Skipping {filename} - not found\\n\")\r\n\r\n    print(\"=\" * 80)\r\n    print(\"âœ… Testing completed!\")\r\n    print(\"=\" * 80)\r\n\r\n\r\nif __name__ == '__main__':\r\n    main()"
        }
    ]
}